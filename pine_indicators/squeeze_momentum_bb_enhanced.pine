//@version=5
indicator("Squeeze Momentum BB Enhanced", overlay=false, max_boxes_count=300)

group_settings = "Main Settings"
group_bb = "Bollinger Bands"
group_momentum = "Momentum Calculation"
group_squeeze = "Squeeze Detection"
group_alerts = "Alert Settings"

basis_length = input.int(20, "Basis Length", minval=1, group=group_settings)
basis = input.source(close, "Basis Source", group=group_settings)

bb_length = input.int(20, "BB Length", minval=1, group=group_bb)
bb_mult = input.float(2.0, "BB Multiplier", minval=0.1, group=group_bb)

kc_length = input.int(20, "KC Length", minval=1, group=group_squeeze)
kc_mult = input.float(1.5, "KC Multiplier", minval=0.1, group=group_squeeze)

mom_length = input.int(12, "Momentum Length", minval=1, group=group_momentum)
mom_smooth = input.int(2, "Momentum Smooth", minval=1, group=group_momentum)

use_linear_reg = input.bool(true, "Use Linear Regression", group=group_momentum)
show_divergence = input.bool(true, "Show Divergence", group=group_alerts)
show_strength = input.bool(true, "Show Strength Meter", group=group_alerts)

ma = ta.sma(basis, basis_length)
std_dev = ta.stdev(basis, bb_length)

bb_upper = ma + bb_mult * std_dev
bb_lower = ma - bb_mult * std_dev

atr = ta.atr(kc_length)
kc_upper = ma + atr * kc_mult
kc_lower = ma - atr * kc_mult

in_squeeze = bb_upper < kc_upper and bb_lower > kc_lower
squeeze_release = not in_squeeze and in_squeeze[1]

mom_raw = use_linear_reg ? 
     ta.linreg(close - ta.sma(close, mom_length), mom_length, 0) : 
     close - ta.sma(close, mom_length)
mom = ta.sma(mom_raw, mom_smooth)

mom_ema_fast = ta.ema(mom, 3)
mom_ema_slow = ta.ema(mom, 8)

mom_color = mom > 0 ? (mom > mom[1] ? color.new(color.green, 0) : 
     color.new(color.lime, 40)) : (mom < mom[1] ? color.new(color.red, 0) : 
     color.new(color.maroon, 40))

mom_strength = math.abs(mom) / (ta.sma(math.abs(mom), 20) + 0.0001)

rsi_for_div = ta.rsi(close, 14)
bb_squeeze_level = (bb_upper - bb_lower) / ma

divergence_bullish = rsi_for_div < 30 and ta.crossover(mom, 0) and 
     squeeze_release
divergence_bearish = rsi_for_div > 70 and ta.crossunder(mom, 0) and 
     squeeze_release

plot(mom_strength * 50, "Momentum Strength", 
     color=color.new(color.cyan, 60), linewidth=1, 
     style=plot.style_area, display=show_strength ? display.all : 
     display.none)

plot(mom, "Momentum", color=mom_color, linewidth=2)
plot(mom_ema_fast, "Momentum Fast EMA", 
     color=color.new(color.blue, 30), linewidth=1)
plot(mom_ema_slow, "Momentum Slow EMA", 
     color=color.new(color.orange, 30), linewidth=1)

hline(0, "Zero Line", color=color.gray, linestyle=hline.style_solid)

plotshape(divergence_bullish and show_divergence, 
     title="Bullish Divergence", location=location.bottom, text="B", 
     textcolor=color.green, color=color.green, size=size.small)
plotshape(divergence_bearish and show_divergence, 
     title="Bearish Divergence", location=location.bottom, text="S", 
     textcolor=color.red, color=color.red, size=size.small)
plotshape(in_squeeze and show_divergence, title="Squeeze Active", 
     location=location.top, text="Q", textcolor=color.gray, 
     color=color.gray, size=size.tiny)

alertcondition(divergence_bullish, title="Bullish Divergence", 
     message="Bullish momentum divergence with squeeze release")
alertcondition(divergence_bearish, title="Bearish Divergence", 
     message="Bearish momentum divergence with squeeze release")
alertcondition(squeeze_release and in_squeeze[1], title="Squeeze Released", 
     message="Market volatility expanding after squeeze")
