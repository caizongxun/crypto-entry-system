//@version=5
indicator("Momentum Divergence with Bollinger Bands", overlay=false, 
     timeframe="", max_boxes_count=500)

group_bb = "Bollinger Bands Settings"
group_momentum = "Momentum Settings"
group_display = "Display Settings"

bb_length = input.int(20, "BB Length", minval=1, group=group_bb)
bb_stddev = input.float(2.0, "BB Std Dev", minval=0.1, group=group_bb)
source_bb = input.source(close, "BB Source", group=group_bb)

momentum_length = input.int(12, "Momentum Period", minval=1, 
     group=group_momentum)
rsi_length = input.int(14, "RSI Period", minval=1, group=group_momentum)
kdj_period = input.int(9, "KDJ Period", minval=1, group=group_momentum)
kdj_smooth_k = input.int(3, "KDJ Smooth K", minval=1, 
     group=group_momentum)
kdj_smooth_d = input.int(3, "KDJ Smooth D", minval=1, 
     group=group_momentum)

show_momentum = input.bool(true, "Show Momentum", group=group_display)
show_rsi = input.bool(true, "Show RSI", group=group_display)
show_kdj = input.bool(true, "Show KDJ", group=group_display)
show_bb_band = input.bool(true, "Show BB Bands", group=group_display)
show_divergence_alert = input.bool(true, "Show Divergence Alert", 
     group=group_display)

color_bullish = color.new(color.green, 0)
color_bearish = color.new(color.red, 0)
color_neutral = color.new(color.gray, 0)

bb_sma = ta.sma(source_bb, bb_length)
bb_std = ta.stdev(source_bb, bb_length)
bb_upper = bb_sma + bb_stddev * bb_std
bb_lower = bb_sma - bb_stddev * bb_std

momentum = source_bb - ta.sma(source_bb, momentum_length)
momentum_ema = ta.ema(momentum, 5)

rsi = ta.rsi(source_bb, rsi_length)

highest_high = ta.highest(high, kdj_period)
lowest_low = ta.lowest(low, kdj_period)
rsv = (close - lowest_low) / (highest_high - lowest_low) * 100

k = ta.sma(rsv, kdj_smooth_k)
d = ta.sma(k, kdj_smooth_d)

momentum_change = momentum - ta.sma(momentum, 1)[1]
momentum_accel = momentum_change > 0

rsi_divergence_bullish = rsi < 30 and ta.crossover(rsi, 30)
rsi_divergence_bearish = rsi > 70 and ta.crossunder(rsi, 70)

kdj_divergence_bullish = k < 20 and ta.crossover(k, d)
kdj_divergence_bearish = k > 80 and ta.crossunder(k, d)

bb_squeeze = (bb_upper - bb_lower) / bb_sma < 0.05
bb_expansion = (bb_upper - bb_lower) / bb_sma > 0.20

mom_color = momentum > 0 ? color_bullish : color_bearish
mom_smoothed_color = momentum_ema > 0 ? color_bullish : color_bearish

rsi_overbought = rsi > 70
rsi_oversold = rsi < 30

kdj_overbought = k > 80
kdj_oversold = k < 20

strength_score = 0.0
if momentum > 0
    strength_score := strength_score + 1
if momentum_ema > 0
    strength_score := strength_score + 1
if rsi > 50
    strength_score := strength_score + 1
if k > 50
    strength_score := strength_score + 1

plot(momentum, "Momentum", color=mom_color, linewidth=2, 
     display=show_momentum ? display.all : display.none)
plot(momentum_ema, "Momentum EMA", color=mom_smoothed_color, linewidth=1, 
     style=plot.style_line, display=show_momentum ? display.all : 
     display.none)

plot(rsi, "RSI", color=color.blue, linewidth=1, 
     display=show_rsi ? display.all : display.none)
hline(70, "RSI OB", color=color.new(color.red, 50), 
     linestyle=hline.style_dashed, display=show_rsi ? display.all : 
     display.none)
hline(30, "RSI OS", color=color.new(color.green, 50), 
     linestyle=hline.style_dashed, display=show_rsi ? display.all : 
     display.none)
hline(50, "RSI Mid", color=color.new(color.gray, 50), 
     linestyle=hline.style_dotted, display=show_rsi ? display.all : 
     display.none)

plot(k, "KDJ K", color=color.orange, linewidth=1, 
     display=show_kdj ? display.all : display.none)
plot(d, "KDJ D", color=color.purple, linewidth=1, 
     display=show_kdj ? display.all : display.none)
hline(80, "KDJ OB", color=color.new(color.red, 50), 
     linestyle=hline.style_dashed, display=show_kdj ? display.all : 
     display.none)
hline(20, "KDJ OS", color=color.new(color.green, 50), 
     linestyle=hline.style_dashed, display=show_kdj ? display.all : 
     display.none)

plot(bb_upper, "BB Upper", color=color.new(color.gray, 50), linewidth=1, 
     display=show_bb_band ? display.all : display.none)
plot(bb_sma, "BB Mid", color=color.new(color.gray, 70), linewidth=1, 
     style=plot.style_dashed, display=show_bb_band ? display.all : 
     display.none)
plot(bb_lower, "BB Lower", color=color.new(color.gray, 50), linewidth=1, 
     display=show_bb_band ? display.all : display.none)

bb_fill = plot(bb_upper, display=display.none)
bb_fill2 = plot(bb_lower, display=display.none)
fill(bb_fill, bb_fill2, color=color.new(color.blue, 90), 
     title="BB Band Fill", display=show_bb_band ? display.all : 
     display.none)

alertCondition_bullish = (rsi_divergence_bullish or 
     kdj_divergence_bullish) and momentum_accel and bb_expansion
alertCondition_bearish = (rsi_divergence_bearish or 
     kdj_divergence_bearish) and not momentum_accel and bb_expansion

plotshape(alertCondition_bullish and show_divergence_alert, 
     title="Bullish Signal", location=location.bottom, text="U", 
     textcolor=color_bullish, color=color_bullish, size=size.small)
plotshape(alertCondition_bearish and show_divergence_alert, 
     title="Bearish Signal", location=location.bottom, text="D", 
     textcolor=color_bearish, color=color_bearish, size=size.small)

alertcondition(alertCondition_bullish, title="Bullish Divergence Alert", 
     message="Bullish momentum divergence detected with BB expansion")
alertcondition(alertCondition_bearish, title="Bearish Divergence Alert", 
     message="Bearish momentum divergence detected with BB expansion")
