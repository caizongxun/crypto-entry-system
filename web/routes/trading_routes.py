from flask import Blueprint, request, jsonify, current_app\nfrom datetime import datetime\nimport logging\n\ntrading_bp = Blueprint('trading', __name__, url_prefix='/api/trading')\nlogger = logging.getLogger(__name__)\n\n\n@trading_bp.before_request\ndef init_auto_trader():\n    if not hasattr(current_app, 'auto_trader'):\n        from trading.auto_trader import AutoTrader\n        current_app.auto_trader = AutoTrader(\n            initial_balance=1000.0,\n            position_size_percent=0.1,\n            confidence_threshold=0.5\n        )\n\n\n@trading_bp.route('/account-summary', methods=['GET'])\ndef get_account_summary():\n    try:\n        summary = current_app.auto_trader.get_account_summary()\n        return jsonify({\n            'status': 'success',\n            'summary': summary,\n            'positions': summary.get('open_positions', []),\n            'trade_history': [t for t in current_app.auto_trader.export_trades() if t['status'] == 'CLOSED']\n        })\n    except Exception as e:\n        logger.error(f\"Account summary error: {e}\")\n        return jsonify({'status': 'error', 'message': str(e)}), 500\n\n\n@trading_bp.route('/parameters', methods=['GET', 'POST'])\ndef manage_parameters():\n    try:\n        if request.method == 'GET':\n            return jsonify({\n                'status': 'success',\n                'parameters': {\n                    'initial_balance': current_app.auto_trader.initial_balance,\n                    'position_size_percent': current_app.auto_trader.position_size_percent,\n                    'confidence_threshold': current_app.auto_trader.confidence_threshold\n                }\n            })\n        \n        elif request.method == 'POST':\n            data = request.get_json()\n            initial_balance = data.get('initial_balance')\n            position_size_percent = data.get('position_size_percent')\n            confidence_threshold = data.get('confidence_threshold')\n            \n            current_app.auto_trader.set_parameters(\n                initial_balance=initial_balance,\n                position_size_percent=position_size_percent,\n                confidence_threshold=confidence_threshold\n            )\n            \n            return jsonify({\n                'status': 'success',\n                'message': 'Parameters updated',\n                'parameters': {\n                    'initial_balance': current_app.auto_trader.initial_balance,\n                    'position_size_percent': current_app.auto_trader.position_size_percent,\n                    'confidence_threshold': current_app.auto_trader.confidence_threshold\n                }\n            })\n    except Exception as e:\n        logger.error(f\"Parameter management error: {e}\")\n        return jsonify({'status': 'error', 'message': str(e)}), 500\n\n\n@trading_bp.route('/execute-signal', methods=['POST'])\ndef execute_signal():\n    try:\n        signal_data = request.get_json()\n        \n        if not signal_data:\n            return jsonify({'status': 'error', 'message': 'No signal data provided'}), 400\n        \n        signal_data['timestamp'] = signal_data.get('timestamp', datetime.now().isoformat())\n        \n        trade = current_app.auto_trader.process_signal(signal_data)\n        \n        if not trade:\n            return jsonify({\n                'status': 'rejected',\n                'message': f\"Signal rejected - confidence below threshold ({current_app.auto_trader.confidence_threshold:.0%})\",\n                'reason': 'confidence_threshold',\n                'confidence': signal_data.get('confidence', 0),\n                'threshold': current_app.auto_trader.confidence_threshold\n            })\n        \n        summary = current_app.auto_trader.get_account_summary()\n        return jsonify({\n            'status': 'success',\n            'message': 'Signal executed',\n            'trade': trade.to_dict(),\n            'account_summary': summary\n        })\n    except Exception as e:\n        logger.error(f\"Signal execution error: {e}\")\n        return jsonify({'status': 'error', 'message': str(e)}), 500\n\n\n@trading_bp.route('/trade-history', methods=['GET'])\ndef get_trade_history():\n    try:\n        limit = request.args.get('limit', 50, type=int)\n        trades = current_app.auto_trader.export_trades()\n        return jsonify({\n            'status': 'success',\n            'trades': trades[-limit:],\n            'total': len(trades)\n        })\n    except Exception as e:\n        logger.error(f\"Trade history error: {e}\")\n        return jsonify({'status': 'error', 'message': str(e)}), 500\n\n\n@trading_bp.route('/reset', methods=['POST'])\ndef reset_trading():\n    try:\n        data = request.get_json() or {}\n        initial_balance = data.get('initial_balance')\n        \n        current_app.auto_trader.reset(initial_balance=initial_balance)\n        \n        return jsonify({\n            'status': 'success',\n            'message': 'Trading reset',\n            'account_summary': current_app.auto_trader.get_account_summary()\n        })\n    except Exception as e:\n        logger.error(f\"Reset error: {e}\")\n        return jsonify({'status': 'error', 'message': str(e)}), 500\n\n\n@trading_bp.route('/auto-trading/status', methods=['GET'])\ndef get_auto_trading_status():\n    try:\n        return jsonify({\n            'status': 'success',\n            'auto_trading_enabled': True,\n            'parameters': {\n                'confidence_threshold': current_app.auto_trader.confidence_threshold,\n                'position_size_percent': current_app.auto_trader.position_size_percent,\n                'initial_balance': current_app.auto_trader.initial_balance,\n                'current_balance': current_app.auto_trader.current_balance\n            }\n        })\n    except Exception as e:\n        logger.error(f\"Status error: {e}\")\n        return jsonify({'status': 'error', 'message': str(e)}), 500\n"